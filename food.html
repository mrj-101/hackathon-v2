<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta charset="utf-8">
  <title>Hackathon 2025</title>
  <link rel="icon" type="image/x-icon" href="assets/images/favicon.ico">
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="assets/css/portal.css">
  <link rel="stylesheet" href="assets/css/all.min.css">
</head>

<body class="app">

  <my-header></my-header>

  <div class="app-wrapper">
    <div class="app-content pt-3 p-md-3 p-lg-4">
      <div class="container-xl">
        <h1 class="text-center">รายการอาหาร (Food List)</h1>

        <div id="data_area"
          class="row justify-content-between row-cols-2 row-cols-md-4 bg-white py-2 row-gap-3 rounded-md">
        </div>
      </div>
    </div>
  </div>

  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header bg-primary text-white">
        <strong class="me-auto">รายงานการสั่งซื้ออาหาร</strong>
        <small>ครัวไทยโฮมเมด</small>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body"></div>
    </div>
  </div>

  <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="staticBackdropLabel">รายละเอียดรายการอาหาร</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>hello</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิดหน้าต่าง</button>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/js/partial.js"></script>
  <script src="assets/js/all.min.js"></script>
  <script src="assets/js/popper.min.js"></script>
  <script src="assets/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/app.js"></script>
  <script src="assets/js/script.js"></script>
</body>

</html>

<script>

  let datas = [];

  document.addEventListener('DOMContentLoaded', async function () {
    let url = 'http://54.169.154.143:3096/food-menus';
    // let url = './json/hotels.json';
    await fetch(url)
      .then(res => res.json())
      .then(json => {
        datas = json;
        renderFoods(json);
      })
      .catch(err => {
        console.log(`Error: ${err}`)
      })
  })

  function showToast(message) {
    const toastLiveExample = document.getElementById('liveToast');
    const toastBody = toastLiveExample.querySelector('.toast-body');
    toastBody.textContent = message;

    const toast = new bootstrap.Toast(toastLiveExample);
    toast.show();
  }

  function orderFood(id, name, price) {
    // 1. Retrieve the existing array or initialize an empty one
    let myDataArray = JSON.parse(sessionStorage.getItem('basket')) || [];

    // 2. Add new data to the array
    if (myDataArray.some(item => item.id === id)) {
      // If the item already exists, increment the amount
      myDataArray = myDataArray.map(item => {
        if (item.id === id) {
          return { ...item, amount: item.amount + 1 };
        }
        return item;
      });
    } else {
      // If the item does not exist, add it with amount 1
      myDataArray.push({ id: id, name: name, price: price, amount: 1 });
    }

    // 3. Store the updated array back into session storage
    sessionStorage.setItem('basket', JSON.stringify(myDataArray));
    showToast(`เพิ่ม ${name} ลงในตะกร้าเรียบร้อย`);

    // Optional: Verify the content
    // console.log(JSON.parse(sessionStorage.getItem('basket')));

    if (JSON.parse(sessionStorage.getItem('basket'))?.length == 1) {
      window.location.href = 'food.html';
    }

  }

  function showDetail(id) {
    // Find the food item by id from datas
    const food = datas.find(item => String(item.id) === String(id));
    if (food) {
      // Fill modal body with food details
      const modalBody = document.querySelector('#staticBackdrop .modal-body');
      modalBody.innerHTML = `
        <img src="${food.image}" alt="${food.name}" class="img-fluid mb-3 rounded">
        <h5>${food.name}</h5>
        <p>${food.description}</p>
        <p><strong>Price:</strong> ${food.price} Baht</p>
        <p><strong>ระดับความเผ็ดแซ่บ</strong> ${food.spice_level}</p>
        <p><strong>ส่วนประกอบ</strong> ${food.ingredients}</p>
      `;

      if (food.allergens.length ) {
        modalBody.innerHTML += `<p class="text-center"><strong>ไม่เหมาะสำหรับผู้แพ้ส่วนประกอบ</strong> <span class="text-center text-danger">${food.allergens}</span></p>`;  
      }
      // Show the modal
      const modal = new bootstrap.Modal(document.getElementById('staticBackdrop'));
      modal.show();
    }
  }

  function renderFoods(foods) {
    let data_area = document.querySelector('#data_area');
    if (foods.length > 0) {
      let data = ``
      foods.forEach(f => {
        data += `
              <div class="col col-6 col-md-3">
                <div class="card h-100" style="width: 18rem;">
                  <img src="${f.image}" class="card-img-top object-fit-cover" style="height: 240px;" alt="picture">
                  <div class="card-body">
                    <p class="card-text">
                      <strong>${f.name}</strong><br>
                      ${f.description}<br>
                      <strong>Price: </strong> ${f.price} Baht
                      <p class="mt-2 d-block text-center">
                        <button class="btn btn-primary text-white" onclick="showDetail('${f.id}')">รายละเอียด</button>
                        <button class="btn btn-secondary text-white" onclick="orderFood('${f.id}', '${f.name}', ${f.price})">สั่งอาหาร</button>
                      </p>
                    </p>
                  </div>
                </div>
              </div>
            `
      });
      data_area.innerHTML = data
    } else {
      console.log(`No data`)
    }
  }
</script>